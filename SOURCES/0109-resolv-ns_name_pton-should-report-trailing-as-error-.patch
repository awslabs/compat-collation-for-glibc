From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Florian Weimer <fweimer@redhat.com>
Date: Sat, 11 Nov 2017 11:41:45 +0100
Subject: [PATCH] resolv: ns_name_pton should report trailing \ as error [BZ
 #22413]

(cherry picked from commit 9e0ad3049dbae88d615bfb038e53bf365a39a634)

diff --git a/ChangeLog b/ChangeLog
index 7650614fcb011c8ab413d34fd5642584c6af6fa0..3f6fedf4abbd83dfef54dee73251f18d6292efb7 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -113,6 +113,12 @@
 	* resolv/tst-resolv-nondecimal.c: Likewise.
 	* sysdeps/posix/getaddrinfo.c (gaih_inet): Call __inet_aton_exact.
 
+2017-11-11  Florian Weimer  <fweimer@redhat.com>
+
+	[BZ #22413]
+	* resolv/ns_name.c (ns_name_pton): Treat trailing backslash as error.
+	* resolv/tst-ns_name_pton.c (tests): Add trailing backslash tests.
+
 2017-11-11  Florian Weimer  <fweimer@redhat.com>
 
 	* resolv/tst-ns_name_pton.c: New file.
diff --git a/resolv/ns_name.c b/resolv/ns_name.c
index 08a75e2fe0b4edd64f6e6609d88806f54b57fa51..73213fee2dca530baf1abcb6dc52024db9d40060 100644
--- a/resolv/ns_name.c
+++ b/resolv/ns_name.c
@@ -222,6 +222,11 @@ ns_name_pton(const char *src, u_char *dst, size_t dstsiz)
 		}
 		*bp++ = (u_char)c;
 	}
+	if (escaped) {
+		/* Trailing backslash.  */
+		__set_errno (EMSGSIZE);
+		return -1;
+	}
 	c = (bp - label - 1);
 	if ((c & NS_CMPRSFLGS) != 0) {		/*%< Label too big. */
 		__set_errno (EMSGSIZE);
diff --git a/resolv/tst-ns_name_pton.c b/resolv/tst-ns_name_pton.c
index 879d97c9d3816210a4aa3b64f019d83e4189e227..73bdb05e08e405dc0a9950e5940c635edfb0d96f 100644
--- a/resolv/tst-ns_name_pton.c
+++ b/resolv/tst-ns_name_pton.c
@@ -127,6 +127,13 @@ static const struct test_case tests[] =
       "\377\377", NULL, },
     { STRING63OCT "." STRING63OCT "." STRING63OCT "." STRING60OCT
       "\377\377\377", NULL, },
+    { "\\", NULL, },
+    { "\\\\", "\\\\", false },
+    { "\\\\.", "\\\\", true },
+    { "\\\\\\", NULL, },
+    { "a\\", NULL, },
+    { "a.\\", NULL, },
+    { "a.b\\", NULL, },
   };
 
 static int
